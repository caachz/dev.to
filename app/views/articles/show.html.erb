<% title @article.title %>

<%= render "shared/webcomponents_loader_script" %>
<%# imports some js from the web  %>
<%= javascript_pack_tag "clipboardCopy", defer: true %>
<%# webpacker the loads js on the client side and repopulates html skeleton from the back end (page below) %>

<%# create temp file that stores data for 30 hours %>
<% cache("content-related-optional-scripts-#{@article.id}-#{@article.updated_at}", expires_in: 30.hours) do %>
<%# if the article has a gist tag %>
  <% if @article.processed_html.include? "ltag_gist-liquid-tag" %>
  <!-- run below script that imports js function -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/postscribe/2.0.8/postscribe.min.js"
            integrity="sha256-xOIPU/XvDtRLeDQ3qj9GOKmlbMSqKa6D7ZIS6ygHBSo="
            crossorigin="anonymous" defer></script>
            <!-- run this function until postscribe loads properly -->
    <script defer>
      var waitingOnPostscribe = setInterval(function () {
        if (typeof (postscribe) === "function") {
          clearInterval(waitingOnPostscribe);
          var els = document.getElementsByClassName("ltag_gist-liquid-tag");
          for (var i = 0; i < els.length; i++) {
            var current = els[i];
            postscribe(current, current.firstElementChild.outerHTML, {
              beforeWrite: function (context) {
                return function (text) {
                  if (context.childElementCount > 3) {
                    return "";
                  }
                  return text;
                }
              }(current)
            });
          }
        }
      }, 500)
    </script>
  <% end %>
<%# if html is a runkit element %>
  <% if @article.processed_html.include? "runkit-element" %>
  <%# load this runkit tag %>
    <%= javascript_include_tag "https://embed.runkit.com" %>
  <% end %>
<% end %>


<%# if the user is the user who posted the article and is navigating internally %>
<% if internal_navigation? %>
<%# find article from dev.to app domain and display desc and tags  %>
    <link rel="canonical" href="<%= @article.canonical_url.presence || "https://#{ApplicationConfig['APP_DOMAIN']}#{@article.path}" %>" />
    <meta name="description" content="<%= @article.description_and_tags %>">
    <meta name="keywords" content="<%= @article.cached_tag_list %>, software, coding, development, engineering, inclusive, community">
<% else %>
<%# if not internal user load page meta data %>
  <%= content_for :page_meta do %>
  <%# get article link and description and tags %>
    <link rel="canonical" href="<%= @article.canonical_url.presence || "https://#{ApplicationConfig['APP_DOMAIN']}#{@article.path}" %>" />
    <meta name="description" content="<%= @article.description_and_tags %>">
    <meta name="keywords" content="<%= @article.cached_tag_list %>, software, coding, development, engineering, inclusive, community">
<!-- assign more meta properties to the articles that create related links and types and social media of the user-->
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://dev.to<%= @article.path %>" />
    <meta property="og:title" content="<%= @article.title %>" />
    <meta property="og:description" content="<%= @article.description || "An article from the community" %>" />
    <meta property="og:site_name" content="<%= community_qualified_name %>" />
    <meta name="twitter:site" content="@<%= SiteConfig.social_networks_handle %>">
    <meta name="twitter:creator" content="@<%= @user.twitter_username %>">
    <meta name="twitter:title" content="<%= @article.title %>">
    <meta name="twitter:description" content="<%= @article.description || "An article from the community" %>">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:widgets:new-embed-design" content="on">
    <!-- if article is published also add social image -->
    <% if @article.published %>
      <meta property="og:image" content="<%= article_social_image_url(@article) %>" />
      <meta name="twitter:image:src" content="<%= article_social_image_url(@article) %>">
    <% end %>
    <%# if article isnt published or has low positive reactions and low comments and is not featured or featured number is low and score is lower than -10%>
    <% if !@article.published || (@article.positive_reactions_count < 7 && @article.user.comments_count < 1 && !@article.featured) ||
      @article.featured_number.to_i < 1500000000 || @article.score < -10 %>
      <%# update meta data for unpopular articles %>
      <meta name="googlebot" content="noindex">
      <meta name="googlebot" content="nofollow">
    <% end %>
  <% end %>
<% end %>

<div class="home">
  <!-- setting up basic article information with data tags -->
  <div
    class="container article"
    id="article-show-container"
    data-author-id="<%= @article.user_id %>"
    data-live="<%= @article.live_now %>"
    data-path="<%= @article.path %>"
    data-published="<%= @article.published? %>">
    <% if @article.video_state == "PROGRESSING" %>
      <h1 style="text-align:center;">⏳ Video Transcoding In Progress ⏳</h1>
    <% end %>
    <!-- set up more article info in meta data -->
    <article itemscope itemtype="http://schema.org/Article" itemprop="mainEntity">
      <meta itemprop="url" content="https://dev.to<%= @article.path %>">
      <meta itemprop="image" content="<%= article_social_image_url(@article) %>">
      <div itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
          <meta itemprop="url" content="<%= asset_path "android-icon-192x192.png" %>">
          <meta itemprop="width" content="192">
          <meta itemprop="height" content="192">
        </div>
        <meta itemprop="name" content="DEV Community">
      </div>
      <section>
        <!-- if article isnt published create link to editing article -->
        <% if !@article.published %>
          <a href="<%= @article.path %>/edit" class="unpublished">
            Unpublished Post. This URL is public but secret, so share at your own discretion.
            <em style="display: inline-block;">Click to edit.</em>
          </a>
        <% end %>
        <%# if the article has a video %>
        <% if @article.video.present? %>
        <%# render video player partial to display video %>
          <%= render "articles/video_player", meta_tags: true, article: @article %>
          <%# if article has a main image %>
        <% elsif @article.main_image.present? %>
        <%# style image to display on page properly %>
          <div class="image image-final" style="background-color:<%= @article.main_image_background_hex_color %>;background-image:url(<%= cloud_cover_url(@article.main_image) %>)">
          </div>
        <% else %>
        <!-- if no image or video just let be blank -->
          <div class="blank-space"></div>
        <% end %>
      </section>
      <header class="title" id="main-title">
        <!-- if there's an organization related to the article -->
        <% if @organization %>
        <%# create link to organization profile and display image %>
          <a href="<%= @organization.path %>" class="org-branded-title-link">
            <div class="org-branded-title">
              <img src="<%= ProfileImage.new(@organization).get(width: 50) %>" class="org-pic" alt="<%= @organization.name %> profile image"> <%= @organization.name %>
            </div>
          </a>
        <% end %>
        <%# display article title %>
        <h1 class="<%= @article.title_length_classification %>" itemprop="name headline">
          <%= @article.title %>
        </h1>
        <h3>
          <!-- create link to author's profile and show profile image of user -->
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <meta itemprop="url" content="https://dev.to/<%= @user.username %>">
            <a href="/<%= @user.username %>" class="author">
              <img class="profile-pic" src="<%= ProfileImage.new(@user).get(width: 50) %>" alt="<%= @user.username %> profile image" />
              <span itemprop="name"><%= @user.name %></span>
            </a>
          </span>
          <%# if user has twitter associated with their account, create link to twitter profile %>
          <% if @user.twitter_username.present? %>
            <a href="http://twitter.com/<%= @user.twitter_username %>"><%= image_tag_or_inline_svg_tag "twitter", width: 18, height: 18 %></a>
          <% end %>
          <%# if user has github account associated, create link to github profile %>
          <% if @user.github_username.present? %>
            <a href="http://github.com/<%= @user.github_username %>"><%= image_tag_or_inline_svg_tag "github", width: 18, height: 18 %></a>
          <% end %>
          <%# if article has a published at timestamp display when it was published in a more readable time format%>
          <% if @article.published_timestamp.present? %>
            <time itemprop="datePublished" datetime="<%= @article.published_timestamp %>"><%= @article.readable_publish_date %></time>
          <% end %>
          <%# if article has a second user show their user name and link to their profile %>
          <% if @second_user.present? %>
            <em>with <b><a href="<%= @second_user.path %>"><%= @second_user.name %></a></b></em>
          <% end %>
          <%# if the article has third user also display them and a link to their profile %>
          <% if @third_user.present? %>
            <em> and <b><a href="<%= @third_user.path %>"><%= @third_user.name %></a></b></em>
          <% end %>
          <%# if the article has been updated show when the article was edited on and display it nicely%>
          <% if should_show_updated_on?(@article) %>
            <span><em>Updated on <time itemprop="dateModified" datetime="<%= @article.edited_at&.utc&.iso8601 %>"><%= @article.edited_at&.strftime("%b %d, %Y") %></time></em></span>
          <%# if posted on different site too %>
          <% elsif should_show_crossposted_on?(@article) %>
            <span>
              <em>
                <!-- show website it was initially posted on with link to post -->
                Originally published at
                <a href="<%= @article.canonical_url || @article.feed_source_url %>" style="color:#1395b8"><%= get_host_without_www(@article.canonical_url || @article.feed_source_url) %></a>
                on
                <%# and show when it was posted originally %>
                <% if @article.crossposted_at %>
                  <time datetime="<%= (@article.originally_published_at || @article.published_at)&.utc&.iso8601 %>"><%= (@article.originally_published_at || @article.published_at)&.strftime("%b %d, %Y") %></time>
                <% end %>
              </em>
            </span>
          <% end %>
          <!-- show how long it takes to read but only show minimum as 1 minute other wise show actual reading time -->
          <span class="published-at">・<%= @article.reading_time < 1 ? 1 : @article.reading_time %> min read</span>
          <span class="action-space" id="action-space"></span>
        </h3>
        <%# show tage list that is also cached for same amount of time as the article %>
        <% cache("main-article-tags-#{@article.cached_tag_list}", expires_in: 30.hours) do %>
          <div class="tags">
            <%# for every tag in the list display each tag and color them %>
            <% @article.cached_tag_list_array.each do |tag| %>
              <% tag_hash = tag_colors(tag) %>
              <a class="tag" href="/t/<%= tag %>" style="background-color:<%= tag_hash[:background] %>;color:<%= tag_hash[:color] %>">#<%= tag %></a>
            <% end %>
          </div>
        <% end %>
      </header>
      <%# if an article is in a collection %>
      <% if @article.collection_id %>
      <%# show articles collection view %>
        <%= render "articles/collection", position: "top" %>
      <% end %>
      <%# show the body of the article here in html safe version to render html to the page without weird characters %>
      <div class="body" data-article-id="<%= @article.id %>" id="article-body" itemprop="articleBody">
        <%= @article.processed_html.html_safe %>
      </div>
      <%# if the article has body markdown and its a large size and its in a collection render collection view at bottom of page %>
      <% if @article.body_markdown && @article.body_markdown.size > 900 && @article.collection_id %>
        <%= render "articles/collection", position: "bottom" %>
      <% end %>
      <%# render articles actions view %>
      <%= render "articles/actions" %>
    </article>
    <%# if the article body is a smaller size cache about the author for a longer time and load the about the author partial %>
    <% if @article.body_markdown && @article.body_markdown.size > 900 %>
      <% cache("article-about-author-#{@user.id}-#{@user.updated_at}", expires_in: 100.hours) do %>
        <%= render "articles/about_author" %>
      <% end %>
    <% end %>
    <%# render articles organization branding partial and takes the organization as input and render comment partial %>
    <%= render "articles/org_branding", organization: @organization %>
    <%= render "articles/full_comment_area" %>
  </div>
  <%# create new cached section for the suggested articles at the bottom of the page %>
  <% cache("article-bottom-content-#{@article.id}", expires_in: 18.hours) do %>
  <%# use suggester class to find a new article where the article is not itself and finds the first similar article%>
    <% @classic_article = Suggester::Articles::Classic.new(@article, not_ids: [@article.id]).get.first %>
    <%# if this lookup returns an article render article box partial and display the article just found%>
    <% if @classic_article %>
      <%= render "additional_content_boxes/article_box",
                 article: @classic_article,
                 classification: "classic",
                 classification_text: "Classic DEV Post from #{@classic_article.readable_publish_date}",
                 follow_cue: "Follow <a href='#{@classic_article.user.path}'>@#{@classic_article.user.username}</a> to see more of their posts in your feed." %>
    <% end %>
    <%# use article suggester to find a maximum of 4 more articles similar to the current article %>
    <div id="additional-content-area" data-article-id="<%= @article.id %>,<%= @classic_article&.id %>"></div>
    <% suggested_articles = ArticleSuggester.new(@article).articles(max: 4) %>
    <%= render "articles/bottom_content", articles: suggested_articles %>
  <% end %>
</div>
<%# create sidebar for article using article and org or user variables %>
<% stick_nav_cache_key = "sticky-sidebar-#{@article.id}-#{(@organization || @user).profile_updated_at}-#{(@organization || @user).last_article_at}-#{@variant_number}-#{(@organization || @user).pro?}" %>
<% cache(stick_nav_cache_key, expires_in: 50.hours) do %>
  <%= render "articles/sticky_nav" %>
<% end %>

<% cache("specific-article-extra-scripts-#{@article.id}-#{@article.updated_at}", expires_in: 24.hours) do %>
<%# if the article has a video render the article video partial %>
  <% if has_vid?(@article) %>
    <%= render "articles/fitvids" %>
  <% end %>
  <%# if article is tagged as a tweet load the twitter widget %>
  <% if @article.processed_html.include? 'class="twitter-tweet"' %>
    <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  <% end %>
  <%# if article is instagram media load instagram embedded post %>
  <% if @article.processed_html.include? "instagram-media" %>
    <script async defer src="//platform.instagram.com/en_US/embeds.js"></script>
  <% end %>
<% end %>
<%# depending on what the tags are for the article, load the tweet/youtube/etc safe html and cache it %>
<% cache("article-show-scripts", expires_in: 8.hours) do %>
  <script async>
    <%= TweetTag.script.html_safe %>
    <%= YoutubeTag.script.html_safe %>
    <%= PodcastTag.script.html_safe %>
    <%= GistTag.script.html_safe %>
    <%= RunkitTag.script.html_safe %>
    <%= PollTag.script.html_safe %>
  </script>
<% end %>
<%# this loads js on the client side after all html is loaded %>
<%= javascript_pack_tag "webShare", defer: true %>
